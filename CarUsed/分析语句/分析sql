spark-sql  --jars /root/used_car/udf.jar   --master spark://hbase01:7077  
create database car_used;
create table car_used_info(title string,city string ,car_num string ,offer string ,original_price string ,card_time string ,mileage string,card_place string,displacement string ,transmission_case string ,owner string ,time string ,label string ,car_image string ) ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
load data local inpath '/root/used_car/data' overwrite into table car_used_info;
CREATE TEMPORARY FUNCTION huatec_date AS 'com.huatec.udf.DataProcess';
 select title, city, car_num, regexp_extract(offer,'[1-9]\\d*.\\d*|0.\\d*[1-9]\\d*',0) as offer, regexp_extract(original_price,'[1-9]\\d*.\\d*|0.\\d*[1-9]\\d*',0) as original_price  ,card_time,huatec_date(card_time) as car_age , regexp_extract(mileage,'[1-9]\\d*.\\d*|0.\\d*[1-9]\\d*',0) as mileage ,card_place ,displacement  ,transmission_case ,owner ,label from car_used_info limit 10;

#创建表   解析 一些字段
create table car_used_info_process(title string,city string ,car_num string ,offer double ,original_price double ,card_time string ,car_age double ,mileage double ,card_place string,displacement string ,transmission_case string ,owner string ,time string ,label string ) ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';

INSERT OVERWRITE TABLE car_used_info_process  select title, city, car_num, regexp_extract(offer,'[1-9]\\d*.\\d*|0.\\d*[1-9]\\d*',0) as offer, regexp_extract(original_price,'[1-9]\\d*.\\d*|0.\\d*[1-9]\\d*',0) as original_price  ,card_time,huatec_date(card_time) as car_age , regexp_extract(mileage,'[1-9]\\d*.\\d*|0.\\d*[1-9]\\d*',0) as mileage ,card_place ,displacement  ,transmission_case ,owner ,time,label from car_used_info ;

select city ,"car_age",avg(car_age) ,max(car_age),min(car_age) from car_used_info_process group by city union all  select 'all' ,'car_age' ,avg(car_age) ,max(car_age),min(car_age)from car_used_info_process  union all select city ,"offer",avg(offer) ,max(offer),min(offer) from car_used_info_process group by city union all  select 'all' ,'offer' ,avg(offer) ,max(offer),min(offer)from car_used_info_process union all select city ,"original_price",avg(original_price) ,max(original_price),min(original_price) from car_used_info_process group by city union all  select 'all' ,'original_price' ,avg(original_price) ,max(original_price),min(original_price)from car_used_info_process union all select city ,"mileage",avg(mileage) ,max(mileage),min(mileage) from car_used_info_process group by city union all  select 'all' ,'mileage' ,avg(mileage) ,max(mileage),min(mileage)from car_used_info_process;




#建表  获取车龄 二手价 原价 车程的 最大值最小值 和平均值
create table car_used_count_info(city string ,type string ,car_avg string ,car_max string,car_min string )ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
INSERT OVERWRITE TABLE car_used_count_info  select city ,"car_age",avg(car_age) ,max(car_age),min(car_age) from car_used_info_process group by city union all  select 'all' ,'car_age' ,avg(car_age) ,max(car_age),min(car_age)from car_used_info_process  union all select city ,"offer",avg(offer) ,max(offer),min(offer) from car_used_info_process group by city union all  select 'all' ,'offer' ,avg(offer) ,max(offer),min(offer)from car_used_info_process union all select city ,"original_price",avg(original_price) ,max(original_price),min(original_price) from car_used_info_process group by city union all  select 'all' ,'original_price' ,avg(original_price) ,max(original_price),min(original_price)from car_used_info_process union all select city ,"mileage",avg(mileage) ,max(mileage),min(mileage) from car_used_info_process group by city union all  select 'all' ,'mileage' ,avg(mileage) ,max(mileage),min(mileage)from car_used_info_process; 

#  计算不同车龄的二手车数量,  和不同车龄的车程
create table count_mile_by_age(car_age int ,,car_count int ,mileage_avg double )ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
INSERT OVERWRITE TABLE  count_mile_by_age select car_age,count(*) ,CAST(avg(mileage) AS decimal(18,2)) as mileage_avg   from (select round(car_age,0)  as car_age  ,mileage from car_used_info_process ) group by car_age ;
#计算随着车龄的增长,残值率的变化
create table residual_by_age(car_age int ,residual_avg double  )ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
INSERT OVERWRITE TABLE  residual_by_age select car_age ,CAST(avg(residual) AS decimal(18,2)) as residual_avg  from (select round(car_age,0)  as car_age, offer/original_price as residual   from car_used_info_process ) group by car_age ;
#计算不同车程时,车辆的残值率
create table residual_by_mile(mileage int ,residual_avg double  )ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
 INSERT OVERWRITE TABLE residual_by_mile select mileage , CAST(avg(residual) AS decimal(18,2)) as residual_avg  from (select round(mileage,0)  as mileage, offer/original_price as residual   from car_used_info_process ) group by mileage ;
#二手车行驶里程分布
create table count_by_mileage(city string,0to1_car int ,1to2_car  int,2to3_car int, 3to4_car int,4to5_car int, 5to6_car int,6to7_car int, 7to8_car int,8to9_car int,  9to10_car int, 10to11_car int,11to12_car int, 12to13_car int,13to14_car int,14to15_car int,15to16_car int,16to17_car int,17to18_car int,18to19_car int,19to20_car int, 20_car int)ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
  INSERT OVERWRITE TABLE  count_by_mileage select  "all", sum(  case when  mileage <= 1  then 1 else 0 end ) as 0to1_car , sum(  case when  mileage <= 2 and mileage >1  then 1 else 0 end ) as 1to2_car, sum(  case when  mileage <= 3 and mileage >2  then 1 else 0 end ) as 2to3_car, sum(  case when  mileage <= 4 and mileage >3  then 1 else 0 end ) as 3to4_car, sum(  case when  mileage <= 5 and mileage >4  then 1 else 0 end ) as 4to5_car, sum(  case when  mileage <= 6 and mileage >5  then 1 else 0 end ) as 5to6_car, sum(  case when  mileage <= 7 and mileage >6  then 1 else 0 end ) as 6to7_car, sum(  case when  mileage <= 8 and mileage >7  then 1 else 0 end ) as 7to8_car, sum(  case when  mileage <= 9 and mileage >8  then 1 else 0 end ) as 8to9_car, sum(  case when  mileage <= 10 and mileage >9  then 1 else 0 end ) as 9to10_car, sum(  case when  mileage <= 11 and mileage >10  then 1 else 0 end ) as 10to11_car, sum(  case when  mileage <= 12 and mileage >11  then 1 else 0 end ) as 11to12_car, sum(  case when  mileage <= 13 and mileage >12  then 1 else 0 end ) as 12to13_car, sum(  case when  mileage <= 14 and mileage >13  then 1 else 0 end ) as 13to14_car, sum(  case when  mileage <= 15 and mileage >14  then 1 else 0 end ) as 14to15_car, sum(  case when  mileage <= 16 and mileage >15  then 1 else 0 end ) as 15to16_car, sum(  case when  mileage <= 17 and mileage >16  then 1 else 0 end ) as 16to17_car, sum(  case when  mileage <= 18 and mileage >17  then 1 else 0 end ) as 17to18_car, sum(  case when  mileage <= 19 and mileage >18  then 1 else 0 end ) as 18to19_car,sum(  case when  mileage <= 20 and mileage >19  then 1 else 0 end ) as 19to20_car,sum(  case when   mileage >20 then 1 else 0 end ) as 20_car from car_used_info_process union all  select city,  sum(  case when  mileage <= 1  then 1 else 0 end ) as 0to1_car , sum(  case when  mileage <= 2 and mileage >1  then 1 else 0 end ) as 1to2_car, sum(  case when  mileage <= 3 and mileage >2  then 1 else 0 end ) as 2to3_car, sum(  case when  mileage <= 4 and mileage >3  then 1 else 0 end ) as 3to4_car, sum(  case when  mileage <= 5 and mileage >4  then 1 else 0 end ) as 4to5_car, sum(  case when  mileage <= 6 and mileage >5  then 1 else 0 end ) as 5to6_car, sum(  case when  mileage <= 7 and mileage >6  then 1 else 0 end ) as 6to7_car, sum(  case when  mileage <= 8 and mileage >7  then 1 else 0 end ) as 7to8_car, sum(  case when  mileage <= 9 and mileage >8  then 1 else 0 end ) as 8to9_car, sum(  case when  mileage <= 10 and mileage >9  then 1 else 0 end ) as 9to10_car, sum(  case when  mileage <= 11 and mileage >10  then 1 else 0 end ) as 10to11_car, sum(  case when  mileage <= 12 and mileage >11  then 1 else 0 end ) as 11to12_car, sum(  case when  mileage <= 13 and mileage >12  then 1 else 0 end ) as 12to13_car, sum(  case when  mileage <= 14 and mileage >13  then 1 else 0 end ) as 13to14_car, sum(  case when  mileage <= 15 and mileage >14  then 1 else 0 end ) as 14to15_car, sum(  case when  mileage <= 16 and mileage >15  then 1 else 0 end ) as 15to16_car, sum(  case when  mileage <= 17 and mileage >16  then 1 else 0 end ) as 16to17_car, sum(  case when  mileage <= 18 and mileage >17  then 1 else 0 end ) as 17to18_car, sum(  case when  mileage <= 19 and mileage >18  then 1 else 0 end ) as 18to19_car,sum(  case when  mileage <= 20 and mileage >19  then 1 else 0 end ) as 19to20_car,sum(  case when   mileage >20 then 1 else 0 end ) as 20_car from car_used_info_process  group by city ;





#查询二手车原价分布 和 售价分布 
create table count_by_price(type string , 0to_5_count int,5to_10_count int,10to_15_count int,15to_20_count int,20to_25_count int,25to_30_count int,30to_35_count int,35to_40_count int,40to_45_count int,45to_50_count int,50to_55_count int,55to_60_count int,60to_65_count int,65to_70_count int,70to_75_count int,75to_80_count int,80to_85_count int,85to_90_count int,90to_95_count int,95to_100_count int,gt_100_count int) ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
  INSERT OVERWRITE TABLE count_by_price select  'offer' , sum(  case when  offer <= 5 then 1 else 0 end )  , sum(  case when  offer <= 10 and offer >5  then 1 else 0 end ),sum(  case when  offer <= 15 and offer >10  then 1 else 0 end ),sum(  case when  offer <= 20 and offer >15  then 1 else 0 end ),sum(  case when  offer <= 25 and offer >20  then 1 else 0 end ),sum(  case when  offer <= 30 and offer >25  then 1 else 0 end ),sum(  case when  offer <= 35 and offer >30  then 1 else 0 end ),sum(  case when  offer <= 40 and offer >35  then 1 else 0 end ),sum(  case when  offer <= 45 and offer >40  then 1 else 0 end ),sum(  case when  offer <= 50 and offer >45  then 1 else 0 end ),sum(  case when  offer <= 55 and offer >50  then 1 else 0 end ),sum(  case when  offer <= 60 and offer >55  then 1 else 0 end ),sum(  case when  offer <= 65 and offer >60 then 1 else 0 end ),sum(  case when  offer <= 70 and offer >65  then 1 else 0 end ),sum(  case when  offer <= 75 and offer >70  then 1 else 0 end ),sum(  case when  offer <= 80 and offer >75  then 1 else 0 end ),sum(  case when  offer <= 85 and offer >80  then 1 else 0 end ),sum(  case when  offer <= 90 and offer >85  then 1 else 0 end ),sum(  case when  offer <= 95 and offer >90  then 1 else 0 end ),sum(  case when  offer <= 95 and offer >100  then 1 else 0 end ),sum(  case when  offer >100  then 1 else 0 end ) from car_used_info_process  union all select  'original_price' , sum(  case when  original_price <= 5 then 1 else 0 end )  ,  sum(  case when  original_price <= 10 and original_price >5  then 1 else 0 end ),  sum(  case when  original_price <= 15 and original_price >10  then 1 else 0 end ),  sum(  case when  original_price <= 20 and original_price >15  then 1 else 0 end ),  sum(  case when  original_price <= 25 and original_price >20  then 1 else 0 end ),  sum(  case when  original_price <= 30 and original_price >25  then 1 else 0 end ),  sum(  case when  original_price <= 35 and original_price >30  then 1 else 0 end ),  sum(  case when  original_price <= 40 and original_price >35  then 1 else 0 end ),  sum(  case when  original_price <= 45 and original_price >40  then 1 else 0 end ),  sum(  case when  original_price <= 50 and original_price >45  then 1 else 0 end ),  sum(  case when  original_price <= 55 and original_price >50  then 1 else 0 end ),  sum(  case when  original_price <= 60 and original_price >55  then 1 else 0 end ),  sum(  case when  original_price <= 65 and original_price >60 then 1 else 0 end ),  sum(  case when  original_price <= 70 and original_price >65  then 1 else 0 end ),  sum(  case when  original_price <= 75 and original_price >70  then 1 else 0 end ),  sum(  case when  original_price <= 80 and original_price >75  then 1 else 0 end ),  sum(  case when  original_price <= 85 and original_price >80  then 1 else 0 end ),  sum(  case when  original_price <= 90 and original_price >85  then 1 else 0 end ),  sum(  case when  original_price <= 95 and original_price >90  then 1 else 0 end ),  sum(  case when  original_price <= 95 and original_price >100  then 1 else 0 end ),  sum(  case when  original_price >100  then 1 else 0 end ) from car_used_info_process ;


sqoop export --connect 'jdbc:mysql://192.168.14.41:3306/car_used?useUnicode=true&characterEncoding=utf-8' --table car_used_count_info --export-dir /user/hive/warehouse/car_used.db/car_used_count_info --username root -password root -m 1 --fields-terminated-by ','
sqoop export --connect 'jdbc:mysql://192.168.14.41:3306/car_used?useUnicode=true&characterEncoding=utf-8' --table count_by_mileage --export-dir /user/hive/warehouse/car_used.db/count_by_mileage --username root -password root -m 1 --fields-terminated-by ','
sqoop export --connect 'jdbc:mysql://192.168.14.41:3306/car_used?useUnicode=true&characterEncoding=utf-8' --table count_by_price --export-dir /user/hive/warehouse/car_used.db/count_by_price --username root -password root -m 1 --fields-terminated-by ','
sqoop export --connect 'jdbc:mysql://192.168.14.41:3306/car_used?useUnicode=true&characterEncoding=utf-8' --table count_mile_by_age --export-dir /user/hive/warehouse/car_used.db/count_mile_by_age --username root -password root -m 1 --fields-terminated-by ','
sqoop export --connect 'jdbc:mysql://192.168.14.41:3306/car_used?useUnicode=true&characterEncoding=utf-8' --table residual_by_age --export-dir /user/hive/warehouse/car_used.db/residual_by_age --username root -password root -m 1 --fields-terminated-by ','
sqoop export --connect 'jdbc:mysql://192.168.14.41:3306/car_used?useUnicode=true&characterEncoding=utf-8' --table residual_by_mile --export-dir /user/hive/warehouse/car_used.db/residual_by_mile --username root -password root -m 1 --fields-terminated-by ','




count_by_mileage
count_by_price
count_mile_by_age
residual_by_age
residual_by_mile


